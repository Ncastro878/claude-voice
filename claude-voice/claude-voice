#!/bin/bash
# claude-voice - CLI to control Claude Code text-to-speech
# Usage: claude-voice [on|off|status|config|test|voices|uninstall]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/config.json"

# Project directory is parent of script directory (claude-voice/)
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
SETTINGS_FILE="$PROJECT_DIR/.claude/settings.json"

# Initialize config if it doesn't exist
init_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" << 'EOF'
{
  "enabled": true,
  "voice": "Samantha",
  "rate": 200,
  "max_chars": 3000
}
EOF
    fi
}

# Update a config value
set_config() {
    local key="$1"
    local value="$2"
    init_config
    local tmp=$(mktemp)
    jq ".$key = $value" "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
}

# Get a config value
get_config() {
    local key="$1"
    local default="$2"
    if [ -f "$CONFIG_FILE" ]; then
        jq -r "if .$key == null then $default else .$key end" "$CONFIG_FILE"
    else
        echo "$default"
    fi
}

# Show current status
show_status() {
    init_config
    echo "claude-voice status:"
    echo "  enabled:   $(get_config 'enabled' 'true')"
    echo "  voice:     $(get_config 'voice' '"Samantha"')"
    echo "  rate:      $(get_config 'rate' '200') words/min"
    echo "  max_chars: $(get_config 'max_chars' '3000')"
    echo "  location:  $SCRIPT_DIR"
}

# List available voices
list_voices() {
    echo "Available voices:"
    say -v '?' | grep "en_" | awk '{print "  " $1}'
    echo ""
    echo "Set voice with: claude-voice config voice <name>"
}

# Test the current configuration
test_speech() {
    init_config
    local voice=$(get_config 'voice' '"Samantha"')
    local rate=$(get_config 'rate' '200')
    echo "Testing voice: $voice at $rate words/min"
    say -v "$voice" -r "$rate" "Claude voice is working. This is how responses will sound."
}

# Uninstall from this project
do_uninstall() {
    echo "Uninstalling claude-voice from this project..."

    # Kill any running say process
    if [ -f "/tmp/claude-voice.pid" ]; then
        pid=$(cat /tmp/claude-voice.pid 2>/dev/null || true)
        [ -n "$pid" ] && kill "$pid" 2>/dev/null || true
        rm -f /tmp/claude-voice.pid
    fi

    # Remove the /voice skill
    SKILL_DIR="$PROJECT_DIR/.claude/skills/voice"
    if [ -d "$SKILL_DIR" ]; then
        rm -rf "$SKILL_DIR"
        echo "Removed /voice skill"

        # Remove empty skills directory
        if [ -d "$PROJECT_DIR/.claude/skills" ] && [ -z "$(ls -A "$PROJECT_DIR/.claude/skills" 2>/dev/null)" ]; then
            rmdir "$PROJECT_DIR/.claude/skills"
        fi
    fi

    # Remove hook from settings.json
    if [ -f "$SETTINGS_FILE" ]; then
        tmp=$(mktemp)
        jq '
            if .hooks.Stop then
                .hooks.Stop = [.hooks.Stop[] | select(
                    (.hooks // []) | all(.command | (contains("speak-response.sh") or contains("claude-voice")) | not)
                )]
            else
                .
            end |
            if .hooks.Stop == [] then del(.hooks.Stop) else . end |
            if .hooks == {} then del(.hooks) else . end
        ' "$SETTINGS_FILE" > "$tmp" && mv "$tmp" "$SETTINGS_FILE"

        # Remove empty settings file
        if [ "$(cat "$SETTINGS_FILE")" = "{}" ]; then
            rm "$SETTINGS_FILE"
            echo "Removed .claude/settings.json"
        else
            echo "Removed hook from .claude/settings.json"
        fi
    fi

    # Remove empty .claude directory only if completely empty
    if [ -d "$PROJECT_DIR/.claude" ] && [ -z "$(ls -A "$PROJECT_DIR/.claude" 2>/dev/null)" ]; then
        rmdir "$PROJECT_DIR/.claude"
        echo "Removed empty .claude directory"
    fi

    # Remove the claude-voice directory
    echo "Removing $SCRIPT_DIR..."
    rm -rf "$SCRIPT_DIR"

    echo ""
    echo "Uninstall complete!"
    echo "Restart Claude Code for changes to take effect."
}

# Show usage
usage() {
    cat << 'EOF'
claude-voice - Text-to-speech for Claude Code responses (macOS)

Usage: /voice <command> [args]
   or: ./claude-voice/claude-voice <command> [args]

Commands:
  on              Enable speech
  off             Disable speech (stops current speech)
  status          Show current settings
  test            Test current voice settings
  voices          List available macOS voices
  uninstall       Remove claude-voice from this project

Configuration:
  config voice <name>    Set voice (e.g., Samantha, Alex, Daniel)
  config rate <num>      Set speech rate in words/min (default: 200)
  config max <num>       Set max characters to speak (default: 3000)

Examples:
  /voice on
  /voice off
  /voice config voice Daniel
  /voice test
  /voice uninstall
EOF
}

# Main
case "${1:-}" in
    on)
        set_config "enabled" "true"
        echo "claude-voice enabled"
        ;;
    off)
        set_config "enabled" "false"
        # Kill any running say process
        if [ -f "/tmp/claude-voice.pid" ]; then
            pid=$(cat /tmp/claude-voice.pid 2>/dev/null || true)
            [ -n "$pid" ] && kill "$pid" 2>/dev/null || true
            rm -f /tmp/claude-voice.pid
        fi
        echo "claude-voice disabled"
        ;;
    status)
        show_status
        ;;
    test)
        test_speech
        ;;
    voices)
        list_voices
        ;;
    uninstall)
        do_uninstall
        ;;
    config)
        case "${2:-}" in
            voice)
                if [ -z "${3:-}" ]; then
                    echo "Current voice: $(get_config 'voice' '"Samantha"')"
                    echo "Usage: claude-voice config voice <name>"
                else
                    set_config "voice" "\"$3\""
                    echo "Voice set to: $3"
                fi
                ;;
            rate)
                if [ -z "${3:-}" ]; then
                    echo "Current rate: $(get_config 'rate' '200')"
                    echo "Usage: claude-voice config rate <number>"
                elif ! [[ "$3" =~ ^[0-9]+$ ]]; then
                    echo "Error: rate must be a positive integer"
                    exit 1
                else
                    set_config "rate" "$3"
                    echo "Rate set to: $3 words/min"
                fi
                ;;
            max)
                if [ -z "${3:-}" ]; then
                    echo "Current max_chars: $(get_config 'max_chars' '3000')"
                    echo "Usage: claude-voice config max <number>"
                elif ! [[ "$3" =~ ^[0-9]+$ ]]; then
                    echo "Error: max must be a positive integer"
                    exit 1
                else
                    set_config "max_chars" "$3"
                    echo "Max characters set to: $3"
                fi
                ;;
            *)
                echo "Config options: voice, rate, max"
                echo "Usage: claude-voice config <option> [value]"
                ;;
        esac
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        usage
        exit 1
        ;;
esac
